import { useState, useEffect } from "react";
import { Link } from "react-router-dom";
import { designerAPI } from "../../services/api";
import { formatPrice } from "../../utils/currency";
import { useAuth } from "../../context/AuthContext";
import { useFlash } from "../../context/FlashContext";

const Dashboard = () => {
  const { user } = useAuth();
  const { showFlash } = useFlash();
  const [stats, setStats] = useState({});
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchDashboardData();
  }, []);

  const fetchDashboardData = async () => {
    try {
      setLoading(true);
      const response = await designerAPI.getDashboard();
      setStats(response.data.stats || {});
      setOrders(response.data.orders || []);
    } catch (error) {
      console.error("Designer dashboard error:", error);
      showFlash("Failed to load dashboard", "error");
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="container my-4">
        <div className="text-center py-5">
          <div className="spinner-border" role="status">
            <span className="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="container-fluid my-4">
      {/* Page Header with Gradient */}
      <div className="row mb-4">
        <div className="col-md-12">
          <div
            className="card shadow-sm border-0"
            style={{
              background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
            }}
          >
            <div className="card-body text-white">
              <div className="d-flex justify-content-between align-items-center">
                <div>
                  <h2 className="card-title mb-2">
                    <i className="fas fa-paint-brush me-2"></i>Designer
                    Workspace
                  </h2>
                  <p className="card-text mb-0">
                    Welcome, {user?.username}! Manage your custom design orders
                    and track work progress.
                  </p>
                </div>
                <div className="text-end">
                  <div className="h3 mb-0">
                    {(stats.activeOrders || 0) + (stats.completedOrders || 0)}
                  </div>
                  <small>Total Assigned</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Statistics Row with Colored Borders */}
      <div className="row mb-4">
        <div className="col-md-3 mb-3">
          <div className="card shadow-sm border-0 border-start border-warning border-4 h-100">
            <div className="card-body">
              <div className="d-flex justify-content-between align-items-center">
                <div>
                  <h6 className="text-muted mb-2">Pending</h6>
                  <h3 className="mb-0">{stats.pendingOrders || 0}</h3>
                  <small className="text-muted">Awaiting acceptance</small>
                </div>
                <div className="text-warning" style={{ fontSize: "2rem" }}>
                  <i className="fas fa-clock"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="col-md-3 mb-3">
          <div className="card shadow-sm border-0 border-start border-info border-4 h-100">
            <div className="card-body">
              <div className="d-flex justify-content-between align-items-center">
                <div>
                  <h6 className="text-muted mb-2">In Production</h6>
                  <h3 className="mb-0">{stats.activeOrders || 0}</h3>
                  <small className="text-muted">Currently working</small>
                </div>
                <div className="text-info" style={{ fontSize: "2rem" }}>
                  <i className="fas fa-cogs"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="col-md-3 mb-3">
          <div className="card shadow-sm border-0 border-start border-primary border-4 h-100">
            <div className="card-body">
              <div className="d-flex justify-content-between align-items-center">
                <div>
                  <h6 className="text-muted mb-2">Completed</h6>
                  <h3 className="mb-0">{stats.completedOrders || 0}</h3>
                  <small className="text-muted">Delivered</small>
                </div>
                <div className="text-primary" style={{ fontSize: "2rem" }}>
                  <i className="fas fa-check-circle"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="col-md-3 mb-3">
          <div className="card shadow-sm border-0 border-start border-success border-4 h-100">
            <div className="card-body">
              <div className="d-flex justify-content-between align-items-center">
                <div>
                  <h6 className="text-muted mb-2">Total Designs</h6>
                  <h3 className="mb-0">{stats.totalDesigns || 0}</h3>
                  <small className="text-muted">All time</small>
                </div>
                <div className="text-success" style={{ fontSize: "2rem" }}>
                  <i className="fas fa-palette"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Info Alert */}
      <div className="row mb-4">
        <div className="col-md-12">
          <div
            className="alert alert-info alert-dismissible fade show"
            role="alert"
          >
            <i className="fas fa-info-circle me-2"></i>
            <strong>Designer Note:</strong> You only work on{" "}
            <strong>custom 3D design orders</strong> created by customers in the
            Design Studio. Shop product orders are automatically processed and
            don't require designer work.
            <button
              type="button"
              className="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>
        </div>
      </div>

      {/* Orders Table */}
      <div className="row">
        <div className="col-md-12">
          <div className="card shadow-sm">
            <div className="card-header d-flex justify-content-between align-items-center">
              <h3>
                <i className="fas fa-tasks me-2"></i>Your Custom Design Orders
              </h3>
              <Link to="/designer/products" className="btn btn-primary btn-sm">
                <i className="fas fa-tshirt me-1"></i>Manage Products
              </Link>
            </div>
            <div className="card-body">
              {orders.length === 0 ? (
                <div className="alert alert-info">
                  <i className="fas fa-inbox me-2"></i>
                  No custom design orders assigned yet. When a manager assigns a
                  custom design order to you, it will appear here.
                </div>
              ) : (
                <div className="table-responsive">
                  <table className="table table-hover">
                    <thead>
                      <tr>
                        <th>
                          <i className="fas fa-hashtag me-1"></i>Order ID
                        </th>
                        <th>
                          <i className="fas fa-user me-1"></i>Customer
                        </th>
                        <th>
                          <i className="fas fa-box me-1"></i>Items
                        </th>
                        <th>
                          <i className="fas fa-info-circle me-1"></i>Status
                        </th>
                        <th>
                          <i className="fas fa-calendar me-1"></i>Date
                        </th>
                        <th>
                          <i className="fas fa-cog me-1"></i>Actions
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {orders.map((order) => (
                        <tr key={order._id}>
                          <td>
                            <code>{order._id.substring(0, 8)}...</code>
                          </td>
                          <td>{order.customerId?.username || "N/A"}</td>
                          <td>{order.items?.length || 0}</td>
                          <td>
                            <span
                              className={`badge ${
                                order.status === "completed" ||
                                order.status === "delivered"
                                  ? "bg-success"
                                  : order.status === "in_production" ||
                                    order.status === "in-production"
                                  ? "bg-info"
                                  : order.status === "shipped"
                                  ? "bg-primary"
                                  : "bg-warning"
                              }`}
                            >
                              {order.status?.toUpperCase().replace(/_/g, " ") ||
                                "PENDING"}
                            </span>
                          </td>
                          <td>
                            {order.orderDate
                              ? new Date(order.orderDate).toLocaleDateString()
                              : "N/A"}
                          </td>
                          <td>
                            <Link
                              to={`/designer/order/${order._id}`}
                              className="btn btn-sm btn-outline-primary"
                            >
                              <i className="fas fa-eye me-1"></i>View Details
                            </Link>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Dashboard;
